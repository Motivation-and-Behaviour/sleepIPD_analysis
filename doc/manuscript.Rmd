---
title             : "The title"
shorttitle        : "Title"

author: 
  - name          : "First Author"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "Postal address"
    email         : "my@email.com"
    role:         # Contributorship roles (e.g., CRediT, https://casrai.org/credit/)
      - "Conceptualization"
      - "Writing - Original Draft Preparation"
      - "Writing - Review & Editing"
  - name          : "Ernst-August Doelle"
    affiliation   : "1,2"
    role:
      - "Writing - Review & Editing"
      - "Supervision"

affiliation:
  - id            : "1"
    institution   : "Wilhelm-Wundt-University"
  - id            : "2"
    institution   : "Konstanz Business School"

authornote: |
  Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.

  Enter author note here.

abstract: |
  One or two sentences providing a **basic introduction** to the field,  comprehensible to a scientist in any discipline.
  
  <!-- https://tinyurl.com/ybremelq -->
  
keywords          : "keywords"
wordcount         : "X"


floatsintext      : no
linenumbers       : no
draft             : no
mask              : no

figurelist        : no
tablelist         : no
footnotelist      : no

classoption       : "man"
output            : papaja::apa6_pdf
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
source("R/utils.R")
options(warn = -1)
```

```{r load-libraries}
library(targets)
library(gt)
require(ggplot2)
library(papaja)
```

```{r load-targets, include=FALSE}
tar_load(model_list)
tar_load(data_clean)
pretty <- function(x) format(x, big.mark = ",")
```

# Results

The aggregated data-set describes `r nrow(data_clean) |> pretty()` observations of daily physical activity and sleep from `r length(unique(data_clean$participant_id)) |> pretty()` unique participants. Table \@ref(demo) [Mike's table to be inserted] shows demographic information. A table of study characteristics can be found in supplementary materials.

## The effects of physical activity volume on sleep

We estimated the effects of physical activity on sleep (RQ1) using mixed-effects models. We estimated the effect of physical activity volume on sleep by age, and the results are presented in Table \@ref(tab:sleep-by-volume) and Figure \@ref(fig:sleep-by-volume-fig). There was no meaningful relationship between physical activity volume and sleep duration. However, a positive curvilinear relationship was observed between physical activity volume and sleep efficiency, onset, and regularity, which interacted with age. Sleep efficiency improved with greater physical activity volume, but improvements tapered off for older individuals. Physical activity volume and sleep onset had a positive association for younger individuals, but a negative association for older individuals, where sleep onset was reduced among those with the highest physical activity. There was a strong positive association between physical activity volume and sleep regularity, which was strongest among older participants. For participants aged 35 years and above, this link weakened among those with a physical activity volume greater than two standard deviations.

\renewcommand{\arraystretch}{0.7}

```{r sleep-by-volume}
note <- "Adjusted for SES, BMI, and sex. "

format_table <- function(tab) {
  tab$term <- gsub("I\\(", "", tab$term) |>
    gsub("_", " ", x = _) |>
    gsub("\\^2\\)", "$^2$", x = _ )
  tab <- tab[!grepl("^ses", tab$term), ]
  tab <- tab[!grepl("^sex", tab$term), ]
  tab <- tab[!grepl("^bmi", tab$term), ]
  tab$term <- stringr::str_to_sentence(tab$term)
  tab$term <- gsub(" pa ", " PA ", tab$term)
  names(tab) <- c("Term", "$\\beta$ [95\\% CI]", "SE", "t", "p")
  tab
}

fix_model_names <- function(x){
  x <- stringr::str_to_sentence(x)
  x <- gsub("Pa", "PA", x)
  x
}

sleep_names <- c("scale_sleep_duration by scale_pa_volume", "scale_sleep_efficiency by scale_pa_volume", 
"scale_sleep_onset by scale_pa_volume", "scale_sleep_regularity by scale_pa_volume")

sleep_outcomes_by_PA_volume <- lapply(model_list[sleep_names], function(x){
tab <- format_table(x$table)  
tab
})

names(sleep_outcomes_by_PA_volume) <- gsub("scale_", "", names(sleep_outcomes_by_PA_volume)) |> 
  gsub("\\sby.*", "", x = _ ) |> 
  gsub("_", " ", x = _ ) |> 
  fix_model_names()

  papaja::apa_table(sleep_outcomes_by_PA_volume,
                    caption = "Sleep on physical activity volume controlling for SES, gender and BMI",
                    note = note,
                    escape = FALSE)
```

```{r sleep-by-volume-fig, fig.cap = "Sleep metrics on Physical activity volume"}
knitr::include_graphics(here::here("Figures/sleep on pa_volume.jpg"), error = FALSE)
```

## The effects of physical activity intensity on sleep

We estimated how physical activity intensity affects sleep across different age groups. We present the results controlling for sex, SES, and BMI, in Table \@ref(tab:sleep-by-intensity) and Figure \@ref(fig:sleep-by-intensity-fig). We found that higher physical activity intensity is directly proportional to longer sleep duration and better sleep efficiency. In the case of older participants, physical activity intensity had a U-shaped relationship with sleep onset, meaning that individuals with very low or very high physical activity intensity had longer sleep onset. We also found a strong link between physical activity intensity and improved sleep regularity, which weakened at higher intensity levels.

```{r sleep-by-intensity}
sleep_names <- c("scale_sleep_duration by scale_pa_intensity", "scale_sleep_efficiency by scale_pa_intensity", 
"scale_sleep_onset by scale_pa_intensity", "scale_sleep_regularity by scale_pa_intensity")

sleep_outcomes_by_PA_intens <- lapply(model_list[sleep_names], function(x){
tab <- format_table(x$table)  
tab
})

names(sleep_outcomes_by_PA_intens) <- gsub("scale_", "", names(sleep_outcomes_by_PA_intens)) |> 
  gsub("\\sby.*", "", x = _ ) |> 
  gsub("_", " ", x = _ ) |> 
  fix_model_names()

  papaja::apa_table(sleep_outcomes_by_PA_intens,
                    caption = "Sleep on physical activity intensity controlling for SES, gender and BMI",
                    note = note,
                    escape = FALSE)
```

```{r sleep-by-intensity-fig, fig.cap = "Sleep metrics on Physical activity intensity"}
knitr::include_graphics(here::here("Figures/sleep on pa_intensity.jpg"), error = FALSE)
```

## The effects of sleep duration on physical activity

We estimated the effect of sleep duration on physical activity by age. Results, controlling for sex, SES, and BMI are presented in Table \@ref(tab:PA-by-sleep-duration) and Figure \@ref(fig:PA-by-sleep-duration-fig). As age increases, both physical activity volume and intensity decrease. We found a subtle inverted U-shaped relationship between average sleep duration and physical activity volume, where the highest volume of physical activity was linked to average sleep duration.

```{r PA-by-sleep-duration}
var_names <- c(
  "scale_pa_volume by scale_sleep_duration_lag",
  "scale_pa_intensity by scale_sleep_duration_lag"
)

PA_by_sleep_duration <- lapply(model_list[var_names], function(x){
tab <- format_table(x$table)  
tab
})

names(PA_by_sleep_duration) <- gsub("scale_", "", names(PA_by_sleep_duration)) |> 
  gsub("\\sby.*", "", x = _ ) |> 
  gsub("_", " ", x = _ ) |> 
  fix_model_names()

  papaja::apa_table(PA_by_sleep_duration,
                    caption = "Physical activity  by sleep duration controlling for SES, gender and BMI",
                    note = note,
                    escape = FALSE)
```

```{r PA-by-sleep-duration-fig, fig.cap = "Physical activty by sleep duration"}
knitr::include_graphics(here::here("Figures/PA on sleep_duration_lag.jpg"), error = FALSE)
```

## The effects of sleep efficiency on physical activity

We estimated the effect of sleep efficiency on physical activity by age. Results, controlling for sex, SES, and BMI are presented in Table \@ref(tab:PA-by-sleep-efficiency) and Figure \@ref(fig:PA-by-sleep-efficiency-fig). We did not find a relationship between physical activity volume and sleep efficiency. A subtle U-shaped relationship emerged, indicating that individuals with above-average sleep efficiency engaged in more intense physical activity.


```{r PA-by-sleep-efficiency}
var_names <- c(
  "scale_pa_volume by scale_sleep_efficiency_lag",
  "scale_pa_intensity by scale_sleep_efficiency_lag"
)

PA_by_sleep_efficiency <- lapply(model_list[var_names], function(x){
tab <- format_table(x$table)  
tab
})

names(PA_by_sleep_efficiency) <- gsub("scale_", "", names(PA_by_sleep_efficiency)) |> 
  gsub("\\sby.*", "", x = _ ) |> 
  gsub("_", " ", x = _ ) |> 
  fix_model_names()

  papaja::apa_table(PA_by_sleep_efficiency,
                    caption = "Physical activity by sleep efficiency controlling for SES, gender and BMI",
                    note = note,
                    escape = FALSE)
```

```{r PA-by-sleep-efficiency-fig, fig.cap = "Physical activty by sleep efficiency"}
knitr::include_graphics(here::here("Figures/PA on sleep_efficiency_lag.jpg"), error = FALSE)
```

## The effects of sleep onset on physical activity

We estimated the effect of sleep onset on physical activity by age. Results, controlling for sex, SES, and BMI are presented in Table \@ref(tab:PA-by-sleep-onset) and Figure \@ref(fig:PA-by-sleep-onset-fig). There were strong U-shaped relationships where average sleep onset was linked to the highest levels of physical activity volume and intensity. The U-shaped relationship between sleep onset and physical activity volume attenuated for older participants.

```{r PA-by-sleep-onset}
var_names <- c(
  "scale_pa_volume by scale_sleep_onset_lag",
  "scale_pa_intensity by scale_sleep_onset_lag"
)

PA_by_sleep_onset <- lapply(model_list[var_names], function(x){
tab <- format_table(x$table)  
tab
})

names(PA_by_sleep_onset) <- gsub("scale_", "", names(PA_by_sleep_onset)) |> 
  gsub("\\sby.*", "", x = _ ) |> 
  gsub("_", " ", x = _ ) |> 
  fix_model_names()

  papaja::apa_table(PA_by_sleep_onset,
                    caption = "Physical activity by sleep onset controlling for SES, gender and BMI",
                    note = note,
                    escape = FALSE)
```

```{r PA-by-sleep-onset-fig, fig.cap = "Physical activty by sleep onset"}
knitr::include_graphics(here::here("Figures/PA on sleep_onset_lag.jpg"), error = FALSE)
```


## The effects of sleep regularity on physical activity

We estimated the effect of sleep regularity on physical activity by age. Results, controlling for sex, SES, and BMI are presented in Table \@ref(tab:PA-by-sleep-regularity) and Figure \@ref(fig:PA-by-sleep-regularity-fig). There was a U-shaped relationship between sleep regularity and physical activity volume. Participants with below-average sleep regularity tended to have average physical activity volume. Increases in regularity above the average were linked to greater physical activity volume. There was a strong linear relationship between sleep regularity and physical activity intensity which slightly attenuated with age. Greater sleep regularity was associated with greater physical activity the following day.

```{r PA-by-sleep-regularity}
var_names <- c(
  "scale_pa_volume by scale_sleep_regularity_lag",
  "scale_pa_intensity by scale_sleep_regularity_lag"
)

PA_by_sleep_regularity <- lapply(model_list[var_names], function(x){
tab <- format_table(x$table)  
tab
})

names(PA_by_sleep_regularity) <- gsub("scale_", "", names(PA_by_sleep_regularity)) |> 
  gsub("\\sby.*", "", x = _ ) |> 
  gsub("_", " ", x = _ ) |> 
  fix_model_names()

  papaja::apa_table(PA_by_sleep_regularity,
                    caption = "Physical activity by sleep regularity controlling for SES, gender and BMI",
                    note = note,
                    escape = FALSE)
```

```{r PA-by-sleep-regularity-fig, fig.cap = "Physical activty by sleep regularity"}
knitr::include_graphics(here::here("Figures/PA on sleep_regularity_lag.jpg"), error = FALSE)
```

